<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ë¡œê·¸ ë‹¤ë“¬ê¸°</title>

<style>
:root{
  --bg:#fbfbf9;
  --paper:#ffffff;
  --ink:#17181c;
  --sub:#5a5f6b;
  --line:#e7e7e2;
  --accent:#3b5bfd;
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;
}
.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:0 20px;
}
h1{margin:0 0 8px 0;font-size:22px;}
.sub{color:var(--sub);font-size:13px;margin-bottom:20px;}
.card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:18px;
}
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:18px;
  align-items:center;
}
label{font-size:13px;color:var(--sub);}
select,input[type="text"]{
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
}
button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
}
button:hover{background:#f4f4f2;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
textarea{
  width:100%;
  height:420px;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  resize:none;
  font-size:14px;
  line-height:1.7;
}
textarea[readonly]{background:#fafaf8;}
@media(max-width:900px){.grid{grid-template-columns:1fr;}}
#toast{
  position: fixed;
  left: 50%;
  bottom: 30px;
  transform: translateX(-50%);
  background: rgba(20,20,25,0.9);
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.25s ease;
  pointer-events: none;
  z-index: 9999;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>âœï¸ ë¡œê·¸ ë‹¤ë“¬ê¸°</h1>
  <div class="sub">ì§€ë¬¸(*) ì²˜ë¦¬ Â· ëŒ€ì‚¬ ë”°ì˜´í‘œ Â· HTML ì œê±° Â· ë³´í˜¸ í‚¤ì›Œë“œ Â· êµ¬ë¶„ì„  ì •ë¦¬</div>

  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="removeDetails"> &lt;details&gt; ì œê±°</label>
      <label><input type="checkbox" id="removeEmptyLines"> ë¬¸ë‹¨ ë¹ˆ ì¤„ ì œê±°</label>
      <label><input type="checkbox" id="removeHTML"> HTML íƒœê·¸ ì œê±°</label>
      <label><input type="checkbox" id="removeDecor"> êµ¬ë¶„ì„ /ê¸°í˜¸ë§Œ ì¤„ ì œê±°</label>

      <label><input type="checkbox" id="protectEnabled"> ë³´í˜¸ í‚¤ì›Œë“œ</label>
      <input id="protectToken" type="text"
        placeholder="ì˜ˆ: ğŸ§·, KEEP, âš‘  (ì½¤ë§ˆë¡œ êµ¬ë¶„)">

      <label>
        ë”°ì˜´í‘œ
        <select id="quoteStyle">
          <option value="none">ë„£ì§€ ì•ŠìŒ</option>
          <option value="straight">" "</option>
          <option value="doubleCurly" selected>â€œ â€</option>
          <option value="singleCurly">â€˜ â€™</option>
        </select>
      </label>

      <button onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>
      <button onclick="downloadTxt()">TXT ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="clearAll()">ì´ˆê¸°í™”</button>
    </div>

    <div class="grid">
      <textarea id="inputText" placeholder="ì—¬ê¸°ì— ë¡œê·¸ë¥¼ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”"></textarea>
      <textarea id="outputText" readonly placeholder="ë³€í™˜ ê²°ê³¼"></textarea>
    </div>
  </div>
</div>

<div id="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<script>
const input = document.getElementById("inputText");
const output = document.getElementById("outputText");

const removeDetailsEl = document.getElementById("removeDetails");
const removeEmptyLinesEl = document.getElementById("removeEmptyLines");
const removeHTMLCheckbox = document.getElementById("removeHTML");
const removeDecorEl = document.getElementById("removeDecor");
const protectEnabledEl = document.getElementById("protectEnabled");
const protectTokenEl = document.getElementById("protectToken");
const quoteStyleEl = document.getElementById("quoteStyle");

input.addEventListener("input", transformText);
document.querySelectorAll("input,select").forEach(el=>{
  el.addEventListener("change", transformText);
});

// ------------------ ë³´í˜¸ í‚¤ì›Œë“œ ------------------
function getProtectTokens(){
  if (!protectEnabledEl.checked) return [];
  return protectTokenEl.value
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
}
function isProtectedText(t,tokens){
  return tokens.some(tok => t.includes(tok));
}

// ------------------ ê¸°í˜¸/êµ¬ë¶„ì„  íŒì • ------------------
function isDecorOnlyLine(line){
  const s=line.trim();
  if(!s) return false;
  if(/^[-*_â€”â€“]{3,}$/.test(s)) return true;
  if(/^[<>\[\]\(\){}|\\/Â·â€¢â€¦.,:;'"`~!@#$%^&+=-]+$/.test(s)) return true;
  return false;
}
function isDecorOnlyParagraph(p){
  const lines=p.split("\n").map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return false;
  return lines.every(isDecorOnlyLine);
}
function removeDecorLines(p){
  return p.split("\n").filter(l=>!isDecorOnlyLine(l)).join("\n").trim();
}

// ------------------ ë³„í‘œ ì§€ë¬¸ íŒŒì„œ ------------------
function parseChunks(text){
  const s=(text||"").replace(/\r/g,"");
  const out=[];
  let i=0,normal="";
  const flush=()=>{
    if(!normal) return;
    normal.split(/\n\s*\n+/).map(p=>p.trim()).filter(Boolean)
      .forEach(p=>out.push({kind:"normal",text:p}));
    normal="";
  };
  while(i<s.length){
    if(s[i]!=="*"){normal+=s[i++];continue;}
    flush(); i++;
    let content="";
    while(i<s.length&&s[i]!=="*"){content+=s[i++];}
    if(i<s.length&&s[i]==="*") i++;
    out.push({kind:"scene",text:content.trim()});
    while(i<s.length&&/\s/.test(s[i])) i++;
  }
  flush();
  return out;
}

// ------------------ ë©”ì¸ ë³€í™˜ ------------------
function transformText(){
  let text=input.value||"";
  const tokens=getProtectTokens();

  if(removeDetailsEl.checked){
    text=text.replace(/<details[\s\S]*?<\/details>/gi,"");
  }

  if(removeHTMLCheckbox.checked){
    text=text.replace(/<script[\s\S]*?<\/script>/gi,"");
    text=text.replace(/<style[\s\S]*?<\/style>/gi,"");
    text=text.replace(/<br\s*\/?>/gi,"\n");
    text=text.replace(/<\/p>/gi,"\n");
    text=text.replace(/<[^>]+>/g,"");
    text=text.replace(/<[^>\n]*/g,"");
  }

  text=text.replace(/\*\*(.*?)\*\*/g,"$1");

  const chunks=parseChunks(text);
  const [openQ,closeQ]=(()=>{
    if(quoteStyleEl.value==="straight")return['"','"'];
    if(quoteStyleEl.value==="doubleCurly")return['â€œ','â€'];
    if(quoteStyleEl.value==="singleCurly")return['â€˜','â€™'];
    return["",""];
  })();

  const result=chunks.map(({kind,text:t})=>{
    t=t.trim();
    if(!t) return "";

    const protectedHere=isProtectedText(t,tokens);

    if(removeDecorEl.checked&&!protectedHere){
      if(isDecorOnlyParagraph(t)) return "";
      t=removeDecorLines(t);
    }

    if(protectedHere){
      if(removeEmptyLinesEl.checked)
        return t.replace(/\n\s*\n+/g,"\n");
      return t;
    }

    if(kind==="scene"){
      if(removeEmptyLinesEl.checked)
        return t.replace(/\n\s*\n+/g,"\n");
      return t;
    }

    if(isDecorOnlyParagraph(t)) return t;

    if(quoteStyleEl.value==="none") return t;

    return openQ+t+closeQ;
  }).filter(Boolean);

  const joiner=removeEmptyLinesEl.checked?"\n":"\n\n";
  output.value=result.join(joiner).trim();
}

// ------------------ UI ------------------
function copyResult(){
  navigator.clipboard.writeText(output.value);
  showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.opacity="1";
  setTimeout(()=>t.style.opacity="0",1200);
}
function downloadTxt(){
  const blob=new Blob([output.value],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="cleaned_log.txt";a.click();
  URL.revokeObjectURL(url);
}
function clearAll(){input.value="";output.value="";}
</script>
</body>
</html>
