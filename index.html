<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ë¡œê·¸ ë‹¤ë“¬ê¸°</title>
<style>
:root{
  --bg:#fbfbf9;
  --paper:#ffffff;
  --ink:#17181c;
  --sub:#5a5f6b;
  --line:#e7e7e2;
  --accent:#3b5bfd;
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;
}
.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:0 20px;
}
h1{
  margin:0 0 8px 0;
  font-size:22px;
}
.sub{
  color:var(--sub);
  font-size:13px;
  margin-bottom:20px;
}
.card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:18px;
}
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:18px;
  align-items:center;
}
label{
  font-size:13px;
  color:var(--sub);
}
select{
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
}
button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
}
button:hover{
  background:#f4f4f2;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
textarea{
  width:100%;
  height:420px;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  resize:none;
  font-size:14px;
  line-height:1.7;
}
textarea[readonly]{
  background:#fafaf8;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr;}
}
#toast{
  position: fixed;
  left: 50%;
  bottom: 30px;
  transform: translateX(-50%);
  background: rgba(20,20,25,0.9);
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.25s ease;
  pointer-events: none;
  z-index: 9999;
}

</style>
</head>
<body>
<div class="wrap">
  <h1>âœï¸ ë¡œê·¸ ë‹¤ë“¬ê¸°</h1>
  <div class="sub">ì§€ë¬¸(*) ì²˜ë¦¬ Â· ëŒ€ì‚¬ ë”°ì˜´í‘œ Â· details ì œê±° Â· ë¹ˆ ì¤„ ì •ë¦¬</div>

  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="removeDetails"> &lt;details&gt; ì œê±°</label>
      <label><input type="checkbox" id="removeHTML"> HTML íƒœê·¸ ì œê±°</label>
      <label><input type="checkbox" id="removeEmptyLines"> ë¬¸ë‹¨ ë¹ˆ ì¤„ ì œê±°</label>
      <label>
        ë”°ì˜´í‘œ
        <select id="quoteStyle">
          <option value="none">ë„£ì§€ ì•ŠìŒ</option>
          <option value="straight">" "</option>
          <option value="doubleCurly" selected>â€œ â€</option>
          <option value="singleCurly">â€˜ â€™</option>
        </select>
      </label>
      <button onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>
      <button onclick="downloadTxt()">TXT ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="clearAll()">ì´ˆê¸°í™”</button>
    </div>

    <div class="grid">
      <textarea id="inputText" placeholder="ì—¬ê¸°ì— ë¡œê·¸ë¥¼ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”"></textarea>
      <textarea id="outputText" readonly placeholder="ë³€í™˜ ê²°ê³¼"></textarea>
    </div>
  </div>
</div>

<script>
const input = document.getElementById("inputText");
const output = document.getElementById("outputText");

input.addEventListener("input", transformText);
document.getElementById("quoteStyle").addEventListener("change", transformText);
document.getElementById("removeDetails").addEventListener("change", transformText);
document.getElementById("removeEmptyLines").addEventListener("change", transformText);

// ğŸ”¹ v2 ì¶”ê°€: HTML ì œê±° ì²´í¬ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ ì—°ê²°
const removeHTMLCheckbox = document.getElementById("removeHTML");
if(removeHTMLCheckbox){
  removeHTMLCheckbox.addEventListener("change", transformText);
}

// ------------------------------
// 1ï¸âƒ£ ë³„í‘œ ì§€ë¬¸ íŒŒì„œ
// ------------------------------
function parseChunks(text){
  const s = (text || "").replace(/\r/g, "");
  const out = [];

  let i = 0;
  let normalBuf = "";

  const flushNormal = () => {
    if (!normalBuf) return;
    const parts = normalBuf
      .split(/\n\s*\n+/)
      .map(p => p.trim())
      .filter(Boolean);

    for (const p of parts) out.push({ kind: "normal", text: p });
    normalBuf = "";
  };

  while (i < s.length){
    if (s[i] !== "*"){
      normalBuf += s[i];
      i++;
      continue;
    }

    flushNormal();
    i++;

    let content = "";
    while (i < s.length && s[i] !== "*"){
      content += s[i];
      i++;
    }

    if (i < s.length && s[i] === "*") i++;

    out.push({ kind: "scene", text: content.trim() });

    while (i < s.length && (s[i] === " " || s[i] === "\t" || s[i] === "\n")){
      i++;
      if (i < s.length && s[i] === "*") break;
    }
  }

  flushNormal();
  return out;
}

// ------------------------------
// 2ï¸âƒ£ ë”°ì˜´í‘œ ì²˜ë¦¬
// ------------------------------
function getQuotes(style){
  if(style === "straight") return ['"', '"'];
  if(style === "doubleCurly") return ['â€œ', 'â€'];
  if(style === "singleCurly") return ['â€˜', 'â€™'];
  return ["", ""];
}

function isAlreadyQuoted(t){
  const pairs = [['"', '"'], ['â€œ','â€'], ['â€˜','â€™']];
  return pairs.some(([o,c]) => t.startsWith(o) && t.endsWith(c) && t.length >= 2);
}

// ------------------------------
// 3ï¸âƒ£ ë©”ì¸ ë³€í™˜ í•¨ìˆ˜ (v2)
// ------------------------------
function transformText(){
  let text = input.value || "";

  // ğŸ”¹ details ì œê±°
  if(document.getElementById("removeDetails").checked){
    text = text.replace(/<details\b[\s\S]*?<\/details>/gi,"");
    text = text.replace(/^\s*<\/?details.*?>\s*$/gim,"");
    text = text.replace(/<summary.*?>.*?<\/summary>/gi,"");
  }

  // ğŸ”¹ v2: HTML íƒœê·¸ ì œê±° ì˜µì…˜
  if(removeHTMLCheckbox && removeHTMLCheckbox.checked){

    // script/style ì œê±°
    text = text.replace(/<script[\s\S]*?<\/script>/gi,"");
    text = text.replace(/<style[\s\S]*?<\/style>/gi,"");

    // <br> ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    text = text.replace(/<br\s*\/?>/gi,"\n");
    text = text.replace(/<\/p>/gi,"\n");

    // ì¼ë°˜ íƒœê·¸ ì œê±°
    text = text.replace(/<[^>]+>/g,"");

    // ê¹¨ì§„ <íƒœê·¸ í˜•íƒœ ì œê±°
    text = text.replace(/<[^>\n]*/g,"");
  }

  // ğŸ”¹ v2: ë§ˆí¬ë‹¤ìš´ êµµê²Œ ì œê±°
  text = text.replace(/\*\*(.*?)\*\*/g,"$1");
  text = text.replace(/__(.*?)__/g,"$1");

  const chunks = parseChunks(text);

  const quoteStyle = document.getElementById("quoteStyle").value;
  const [openQ, closeQ] = getQuotes(quoteStyle);

  const result = chunks.map(({kind, text: raw}) => {
    let t = (raw || "").trim();
    if(!t) return "";

    if(kind === "scene"){
      if(document.getElementById("removeEmptyLines").checked){
        return t.replace(/\n\s*\n+/g, "\n");
      }
      return t;
    }

    if(quoteStyle === "none") return t;

    if(isAlreadyQuoted(t)) return t;

    return openQ + t + closeQ;
  }).filter(Boolean);

  const joiner = document.getElementById("removeEmptyLines").checked ? "\n" : "\n\n";
  output.value = result.join(joiner).trim();
}

// ------------------------------
// 4ï¸âƒ£ UI í•¨ìˆ˜
// ------------------------------
function copyResult(){
  navigator.clipboard.writeText(output.value);
  showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function showToast(message){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.opacity = "1";
  setTimeout(() => { toast.style.opacity = "0"; }, 1200);
}

function downloadTxt(){
  const blob = new Blob([output.value],{type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="cleaned_log.txt";
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll(){
  input.value="";
  output.value="";
}

  
</script>
<div id="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
</body>
</html>
