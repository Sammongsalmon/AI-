<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ë¡œê·¸ ë‹¤ë“¬ê¸°</title>
<style>
:root{
  --bg:#fbfbf9;
  --paper:#ffffff;
  --ink:#17181c;
  --sub:#5a5f6b;
  --line:#e7e7e2;
  --accent:#3b5bfd;
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;
}
.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:0 20px;
}
h1{
  margin:0 0 8px 0;
  font-size:22px;
}
.sub{
  color:var(--sub);
  font-size:13px;
  margin-bottom:20px;
}
.card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:18px;
}
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:18px;
  align-items:center;
}
label{
  font-size:13px;
  color:var(--sub);
}
select{
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
}
button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
}
button:hover{
  background:#f4f4f2;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
textarea{
  width:100%;
  height:420px;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  resize:none;
  font-size:14px;
  line-height:1.7;
}
textarea[readonly]{
  background:#fafaf8;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr;}
}
#toast{
  position: fixed;
  left: 50%;
  bottom: 30px;
  transform: translateX(-50%);
  background: rgba(20,20,25,0.9);
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.25s ease;
  pointer-events: none;
  z-index: 9999;
}

</style>
</head>
<body>
<div class="wrap">
  <h1>âœï¸ ë¡œê·¸ ë‹¤ë“¬ê¸°</h1>
  <div class="sub">ì§€ë¬¸(*) ì²˜ë¦¬ Â· ëŒ€ì‚¬ ë”°ì˜´í‘œ Â· details ì œê±° Â· ë¹ˆ ì¤„ ì •ë¦¬</div>

  <div class="card">
    <div class="toolbar">
      <label><input type="checkbox" id="removeDetails"> ì ‘ì´ì‹ í† ê¸€ ì œê±°</label>
      <label><input type="checkbox" id="removeHTML"> HTML íƒœê·¸ ì œê±°</label>
      <label><input type="checkbox" id="removeEmptyLines"> ë¬¸ë‹¨ ë¹ˆ ì¤„ ì œê±°</label>
      <label><input type="checkbox" id="protectEnabled"> ë³´í˜¸ í‚¤ì›Œë“œ</label>
<input id="protectToken" type="text" placeholder="ì˜ˆ: ğŸ§· ë˜ëŠ” KEEP" style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);font-size:13px;min-width:180px;">
      <label><input type="checkbox" id="removeDecor"> êµ¬ë¶„ì„ /ê¸°í˜¸ë§Œ ìˆëŠ” ì¤„ ì œê±°</label>
      <label>
        ë”°ì˜´í‘œ
        <select id="quoteStyle">
          <option value="none">ë„£ì§€ ì•ŠìŒ</option>
          <option value="straight">" "</option>
          <option value="doubleCurly" selected>â€œ â€</option>
          <option value="singleCurly">â€˜ â€™</option>
        </select>
      </label>
      <button onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>
      <button onclick="downloadTxt()">TXT ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="clearAll()">ì´ˆê¸°í™”</button>
    </div>

    <div class="grid">
      <textarea id="inputText" placeholder="ì—¬ê¸°ì— ë¡œê·¸ë¥¼ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”"></textarea>
      <textarea id="outputText" readonly placeholder="ë³€í™˜ ê²°ê³¼"></textarea>
    </div>
  </div>
</div>

<script>
const input = document.getElementById("inputText");
const output = document.getElementById("outputText");

const quoteStyleEl = document.getElementById("quoteStyle");
const removeDetailsEl = document.getElementById("removeDetails");
const removeEmptyLinesEl = document.getElementById("removeEmptyLines");

// (ìˆìœ¼ë©´ ì—°ê²°)
const removeHTMLCheckbox = document.getElementById("removeHTML");
const removeDecorEl = document.getElementById("removeDecor");
const protectEnabledEl = document.getElementById("protectEnabled");
const protectTokenEl = document.getElementById("protectToken");

input.addEventListener("input", transformText);
quoteStyleEl.addEventListener("change", transformText);
removeDetailsEl.addEventListener("change", transformText);
removeEmptyLinesEl.addEventListener("change", transformText);

if (removeHTMLCheckbox) removeHTMLCheckbox.addEventListener("change", transformText);
if (removeDecorEl) removeDecorEl.addEventListener("change", transformText);
if (protectEnabledEl) protectEnabledEl.addEventListener("change", transformText);
if (protectTokenEl) protectTokenEl.addEventListener("input", transformText);

// ------------------------------
// ê³µí†µ ìœ í‹¸
// ------------------------------
function getProtectToken(){
  if (!protectEnabledEl || !protectEnabledEl.checked) return "";
  const tok = (protectTokenEl ? protectTokenEl.value : "").trim();
  return tok;
}

function isProtectedText(t, token){
  return !!(token && t && t.includes(token));
}

// "ê¸€ì ì—†ì´ ---< ì´ëŸ° ê²ƒë“¤ë§Œ" íŒì •
// - ë§ˆí¬ë‹¤ìš´ êµ¬ë¶„ì„ (---, *** , ___ ë“±)
// - êº¾ì‡ /ì /ëŒ€ì‹œ ë“± ê¸°í˜¸ë§Œ ì”ëœ©ì¸ ì¤„
function isDecorOnlyLine(line){
  const s = (line || "").trim();
  if (!s) return false;
  // êµ¬ë¶„ì„ ë¥˜: --- *** ___ â€”â€”â€” ë“±
  if (/^[-*_â€”â€“]{3,}$/.test(s)) return true;
  // ê¸°í˜¸ë§Œ: <>â€¦Â·â€¢. ë“± (ì›í•˜ë©´ ë” ëŠ˜ë¦´ ìˆ˜ ìˆìŒ)
  if (/^[<>\[\]\(\){}|\\/Â·â€¢â€¦.,:;'"`~!@#$%^&+=-]+$/.test(s)) return true;
  return false;
}

// ë¬¸ë‹¨ ì „ì²´ê°€ "êµ¬ë¶„ì„ /ê¸°í˜¸ë§Œ"ì¸ì§€ íŒì • (ì—¬ëŸ¬ ì¤„ì´ì–´ë„)
function isDecorOnlyParagraph(p){
  const lines = (p || "").split("\n").map(l => l.trim()).filter(l => l.length > 0);
  if (lines.length === 0) return false;
  return lines.every(isDecorOnlyLine);
}

// ë¬¸ë‹¨ì—ì„œ decor-only ì¤„ ì œê±°
function removeDecorLinesFromParagraph(p){
  const lines = (p || "").split("\n");
  const kept = lines.filter(l => !isDecorOnlyLine(l));
  // ì¤„ ì œê±° í›„ ì•ë’¤ ê³µë°± ì •ë¦¬
  return kept.join("\n").replace(/[ \t]+\n/g, "\n").trim();
}

// ------------------------------
// 1) ë³„í‘œ ì§€ë¬¸ íŒŒì„œ (ìœ ì§€)
// ------------------------------
function parseChunks(text){
  const s = (text || "").replace(/\r/g, "");
  const out = [];

  let i = 0;
  let normalBuf = "";

  const flushNormal = () => {
    if (!normalBuf) return;
    const parts = normalBuf
      .split(/\n\s*\n+/)
      .map(p => p.trim())
      .filter(Boolean);

    for (const p of parts) out.push({ kind: "normal", text: p });
    normalBuf = "";
  };

  while (i < s.length){
    if (s[i] !== "*"){
      normalBuf += s[i];
      i++;
      continue;
    }

    flushNormal();
    i++; // consume starting *

    let content = "";
    while (i < s.length && s[i] !== "*"){
      content += s[i];
      i++;
    }

    if (i < s.length && s[i] === "*") i++; // closing *

    out.push({ kind: "scene", text: content.trim() });

    while (i < s.length && (s[i] === " " || s[i] === "\t" || s[i] === "\n")){
      i++;
      if (i < s.length && s[i] === "*") break;
    }
  }

  flushNormal();
  return out;
}

// ------------------------------
// 2) ë”°ì˜´í‘œ ì²˜ë¦¬
// ------------------------------
function getQuotes(style){
  if(style === "straight") return ['"', '"'];
  if(style === "doubleCurly") return ['â€œ', 'â€'];
  if(style === "singleCurly") return ['â€˜', 'â€™'];
  return ["", ""];
}

function isAlreadyQuoted(t){
  const pairs = [['"', '"'], ['â€œ','â€'], ['â€˜','â€™']];
  return pairs.some(([o,c]) => t.startsWith(o) && t.endsWith(c) && t.length >= 2);
}

// ------------------------------
// 3) v3 í•µì‹¬: details ì œê±° ì‹œ ë³´í˜¸ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ê·¸ ë¬¸ë‹¨ë§Œ ì‚´ë ¤ë‘ê¸°
// ------------------------------
function filterDetailsByProtection(text, token){
  // removeDetails ì˜µì…˜ì´ ì¼œì¡Œì„ ë•Œë§Œ í˜¸ì¶œë¨.
  // - details ë¸”ë¡ ë‚´ì—ì„œ token í¬í•¨ ë¬¸ë‹¨ë§Œ ì¶”ì¶œí•´ì„œ ë¸”ë¡ ìë¦¬ì— ë‚¨ê¹€
  // - tokenì´ ì—†ìœ¼ë©´ details í†µì§¸ ì‚­ì œ
  return (text || "").replace(/<details\b[\s\S]*?<\/details>/gi, (block) => {
    if (!token) return ""; // ë³´í˜¸ í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ì „ë¶€ ì‚­ì œ

    // summary ì œê±° í›„ ë‚´ìš©ë§Œ
    let inner = block
      .replace(/<summary[\s\S]*?<\/summary>/gi, "")
      .replace(/<\/?details[^>]*>/gi, "");

    // ì¼ë‹¨ ë¬¸ë‹¨ ë‹¨ìœ„ë¡œ ë‚˜ëˆ”(ë¹ˆ ì¤„ ê¸°ì¤€)
    const paras = inner.split(/\n\s*\n+/).map(p => p.trim()).filter(Boolean);

    // token ë“¤ì–´ê°„ ë¬¸ë‹¨ë§Œ ë³´ì¡´
    const kept = paras.filter(p => p.includes(token));

    if (kept.length === 0) return "";
    // ë¬¸ë‹¨ ê²½ê³„ ìœ ì§€
    return "\n\n" + kept.join("\n\n") + "\n\n";
  })
  // í˜¹ì‹œ ë‚¨ì€ ë‹¨ë… íƒœê·¸ ì¤„ ì œê±°
  .replace(/^\s*<\/?details.*?>\s*$/gim, "")
  .replace(/^\s*<summary.*?>.*?<\/summary>\s*$/gim, "");
}

// ------------------------------
// 4) ë©”ì¸ ë³€í™˜ (v3)
// ------------------------------
function transformText(){
  let text = input.value || "";
  const token = getProtectToken();

  // (ì„ íƒ) details ì œê±°: ë³´í˜¸ í‚¤ì›Œë“œ ì ìš©
  if(removeDetailsEl.checked){
    text = filterDetailsByProtection(text, token);
    // ë‚¨ì€ summary ì œê±°(í˜¹ì‹œ)
    text = text.replace(/<summary.*?>.*?<\/summary>/gi,"");
  }

  // (ì„ íƒ) HTML íƒœê·¸ ì œê±°
  if(removeHTMLCheckbox && removeHTMLCheckbox.checked){
    text = text.replace(/<script[\s\S]*?<\/script>/gi,"");
    text = text.replace(/<style[\s\S]*?<\/style>/gi,"");

    text = text.replace(/<br\s*\/?>/gi,"\n");
    text = text.replace(/<\/p>/gi,"\n");

    text = text.replace(/<[^>]+>/g,"");
    // ê¹¨ì§„ <... í˜•íƒœ ì œê±° (ì¤„ ëê¹Œì§€ íƒœê·¸ì²˜ëŸ¼ ë¶™ì€ ê²½ìš°)
    text = text.replace(/<[^>\n]*/g,"");
  }

  // ë§ˆí¬ë‹¤ìš´ êµµê²Œ ì œê±° (**êµµê²Œ**, __êµµê²Œ__)
  text = text.replace(/\*\*(.*?)\*\*/g,"$1");
  text = text.replace(/__(.*?)__/g,"$1");

  const chunks = parseChunks(text);

  const quoteStyle = quoteStyleEl.value;
  const [openQ, closeQ] = getQuotes(quoteStyle);

  const result = chunks.map(({kind, text: raw}) => {
    let t = (raw || "").trim();
    if(!t) return "";

    const protectedHere = isProtectedText(t, token);

    // (ì„ íƒ) êµ¬ë¶„ì„ /ê¸°í˜¸ ì¤„ ì œê±°
    if (removeDecorEl && removeDecorEl.checked && !protectedHere){
      // ë¬¸ë‹¨ ì „ì²´ê°€ ê¸°í˜¸ë¿ì´ë©´ ì•„ì˜ˆ ì‚­ì œ
      if (isDecorOnlyParagraph(t)) return "";
      // ì•„ë‹ˆë¼ë©´ ê¸°í˜¸ ì¤„ë§Œ ì œê±°
      t = removeDecorLinesFromParagraph(t);
      if (!t) return "";
    }

    // âœ… ì§€ë¬¸(scene): ë”°ì˜´í‘œ ê¸ˆì§€
    if(kind === "scene"){
      if(removeEmptyLinesEl.checked){
        // scene ë‚´ë¶€ ë¹ˆ ì¤„ë„ ê°™ì´ ì œê±°
        return t.replace(/\n\s*\n+/g, "\n");
      }
      return t;
    }

    // 3) ìš”êµ¬ì‚¬í•­: ê¸€ì ì—†ì´ ---< ê°™ì€ ë¬¸ë‹¨ì€ ëŒ€ì‚¬ ì²˜ë¦¬ ì•ˆ í•´ì„œ ë”°ì˜´í‘œ ê¸ˆì§€
    // (removeDecorê°€ êº¼ì ¸ ìˆì–´ë„ ë”°ì˜´í‘œëŠ” ë¶™ì§€ ì•Šê²Œ)
    if (isDecorOnlyParagraph(t)) return t; // ê·¸ëŒ€ë¡œ ë‘ê±°ë‚˜, ìœ„ ì˜µì…˜ì—ì„œ ì§€ì›Œì§

    // ë”°ì˜´í‘œ ì˜µì…˜ noneì´ë©´ ê·¸ëŒ€ë¡œ
    if(quoteStyle === "none") return t;

    // ì´ë¯¸ ë”°ì˜´í‘œë©´ ìœ ì§€
    if(isAlreadyQuoted(t)) return t;

    return openQ + t + closeQ;
  }).filter(Boolean);

  const joiner = removeEmptyLinesEl.checked ? "\n" : "\n\n";
  output.value = result.join(joiner).trim();
}

// ------------------------------
// UI í•¨ìˆ˜
// ------------------------------
function copyResult(){
  navigator.clipboard.writeText(output.value);
  showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function showToast(message){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.opacity = "1";
  setTimeout(() => { toast.style.opacity = "0"; }, 1200);
}

function downloadTxt(){
  const blob = new Blob([output.value],{type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="cleaned_log.txt";
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll(){
  input.value="";
  output.value="";
}

  
</script>
<div id="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
</body>
</html>
